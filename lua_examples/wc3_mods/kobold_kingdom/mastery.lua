mastery = {}
mastery.nodemap       = {} -- template for placement/mapping.
mastery.nodemap[#mastery.nodemap+1] = {0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {1,6,1,0,1,7,1,0,1,8,1,0,1,4,1,0,1,5,1,0,1,6,1,0,1,7,1,0,1,8,1}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {1,3,1,1,1,4,1,1,1,5,1,1,1,6,1,-1,1,7,1,1,1,8,1,1,1,3,1,1,1,4,1}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {1,8,1,0,1,7,1,0,1,6,1,0,1,5,1,0,1,4,1,0,1,8,1,0,1,7,1,0,1,6,1}
mastery.nodemap[#mastery.nodemap+1] = {1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1}
mastery.nodemap[#mastery.nodemap+1] = {0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0}

-- mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,0,2,1,1,0,1,1,2,0,1,1,1,1,1,1,1,1,1,1,1}
-- mastery.nodemap[#mastery.nodemap+1] = {2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,2,1,1,1,1,1,1,2}
-- mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
-- mastery.nodemap[#mastery.nodemap+1] = {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0}
-- mastery.nodemap[#mastery.nodemap+1] = {0,0,0,0,0,0,0,0,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,0,0,0,0,0,0,0,0}
-- mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1}
-- mastery.nodemap[#mastery.nodemap+1] = {2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,-1,1,1,1,1,1,1,1,2,1,1,1,1,1,1,2}
-- mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1}
-- mastery.nodemap[#mastery.nodemap+1] = {0,0,0,0,0,0,0,0,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,0,0,0,0,0,0,0,0}
-- mastery.nodemap[#mastery.nodemap+1] = {0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0}
-- mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
-- mastery.nodemap[#mastery.nodemap+1] = {2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,2,1,1,1,1,1,1,2}
-- mastery.nodemap[#mastery.nodemap+1] = {1,1,1,1,1,1,1,1,1,1,1,0,2,1,1,0,1,1,2,0,1,1,1,1,1,1,1,1,1,1,1}

-- abilcode | name | 

function mastery:init() -- ran in kui:uigen()
    self.__index   = self
    self.points    = 0
    self.nodemaxx  = 31
    self.centerx   = math.ceil(self.nodemaxx/2)
    self.nodemaxy  = 13
    self.centery   = math.ceil(self.nodemaxy/2)
    self.tipinfo   = color:wrap(color.txt.txtdisable, "|n|nSelect this node to spend a Mastery Point and learn it, gaining its passive benefit."
        .."|n|nYou are awarded 1 Mastery Point each level.")
    self.tipinfo2  = color:wrap(color.txt.txtdisable, "|n|nSelect this node to spend a Mastery Point and learn it, acquiring its active ability.")
        .."|n|n"..color:wrap(color.tooltip.good, "Click learned Mastery Abilities to add and remove them from your skillbar.")
    -- mastery abilities:
    mastery.abillist = {
        ar1 = ability.template.mastery[1],
        ar2 = ability.template.mastery[2],
        fr1 = ability.template.mastery[3],
        fr2 = ability.template.mastery[4],
        na1 = ability.template.mastery[5],
        na2 = ability.template.mastery[6],
        fi1 = ability.template.mastery[7],
        fi2 = ability.template.mastery[8],
        sh1 = ability.template.mastery[9],
        sh2 = ability.template.mastery[10],
        ph1 = ability.template.mastery[11],
        ph2 = ability.template.mastery[12],
        hl1 = ability.template.mastery[13],
        hl2 = ability.template.mastery[14],
        ab1 = ability.template.mastery[15],
        ab2 = ability.template.mastery[16],
    }
    -- amount awarded | stat | node name | icon | stat descript | modifier symbol
    mastery.statlist = {
        str = { 2,      p_stat_strength_b,        "Warrior",            'ReplaceableTextures\\CommandButtons\\BTNGauntletsOfOgrePower.blp', "Strength", ""},
        wis = { 2,      p_stat_wisdom_b,          "Sage",               'ReplaceableTextures\\CommandButtons\\BTNPendantOfMana.blp', "Wisdom", ""},
        ala = { 2,      p_stat_alacrity_b,        "Rogue",              'ReplaceableTextures\\CommandButtons\\BTNDaggerOfEscape.blp', "Alacrity", ""},
        vit = { 2,      p_stat_vitality_b,        "Bruiser",            'ReplaceableTextures\\CommandButtons\\BTNPeriapt.blp', "Vitality", ""},

        ard = { 3,      p_stat_arcane,          "Arcane Spell",         'ReplaceableTextures\\CommandButtons\\BTNManaBurn.blp', "Arcane Spell Damage", "%%"},
        frd = { 3,      p_stat_frost,           "Frost Spell",          'ReplaceableTextures\\CommandButtons\\BTNDarkRitual.blp', "Frost Spell Damage", "%%"},
        nad = { 3,      p_stat_nature,          "Nature Spell",         'ReplaceableTextures\\CommandButtons\\BTNRegenerate.blp', "Nature Spell Damage", "%%"},
        fid = { 3,      p_stat_fire,            "Fire Spell",           'ReplaceableTextures\\CommandButtons\\BTNImmolationOn.blp', "Fire Spell Damage", "%%"},
        shd = { 3,      p_stat_shadow,          "Shadow Spell",         'ReplaceableTextures\\CommandButtons\\BTNFaerieFire.blp', "Shadow Spell Damage", "%%"},
        phd = { 3,      p_stat_phys,            "Physical Spell",       'ReplaceableTextures\\CommandButtons\\BTNDeathPact.blp', "Physical Spell Damage", "%%"},

        abd = { 2,      p_stat_dmg_arcane,      "Arcane Amplification",    'ReplaceableTextures\\CommandButtons\\BTNReplenishMana.blp', "Added Arcane Damage", "%%"},
        rbd = { 2,      p_stat_dmg_frost,       "Frost Amplification",     'ReplaceableTextures\\CommandButtons\\BTNBreathOfFrost.blp', "Added Frost Damage", "%%"},
        nbd = { 2,      p_stat_dmg_nature,      "Nature Amplification",    'ReplaceableTextures\\CommandButtons\\BTNMonsoon.blp', "Added Nature Damage", "%%"},
        fbd = { 2,      p_stat_dmg_fire,        "Fire Amplification",      'ReplaceableTextures\\CommandButtons\\BTNFire.blp', "Added Fire Damage", "%%"},
        sbd = { 2,      p_stat_dmg_shadow,      "Shadow Amplification",    'ReplaceableTextures\\CommandButtons\\BTNPossession.blp', "Added Shadow Damage", "%%"},
        pbd = { 2,      p_stat_dmg_phys,        "Physical Amplification",  'ReplaceableTextures\\CommandButtons\\BTNImpale.blp', "Added Physical Damage", "%%"},

        arr = { 3,      p_stat_arcane_res,      "Arcane Ward",          'ReplaceableTextures\\CommandButtons\\BTNOrbOfLightning.blp', "Arcane Resistance", "%%"},
        frr = { 3,      p_stat_frost_res,       "Frost Ward",           'ReplaceableTextures\\CommandButtons\\BTNOrbOfFrost.blp', "Frost Resistance", "%%"},
        nar = { 3,      p_stat_nature_res,      "Nature Ward",          'ReplaceableTextures\\CommandButtons\\BTNOrbOfVenom.blp', "Nature Resistance", "%%"},
        fir = { 3,      p_stat_fire_res,        "Fire Ward",            'ReplaceableTextures\\CommandButtons\\BTNOrbOfFire.blp', "Fire Resistance", "%%"},
        shr = { 3,      p_stat_shadow_res,      "Shadow Ward",          'ReplaceableTextures\\CommandButtons\\BTNOrbOfDarkness.blp', "Shadow Resistance", "%%"},
        phr = { 3,      p_stat_phys_res,        "Physical Ward",        'ReplaceableTextures\\CommandButtons\\BTNOrbofSlowness.blp', "Physical Resistance", "%%"},

        bhp = { 3,      p_stat_bhp,             "Toughness",            'ReplaceableTextures\\CommandButtons\\BTNHealthStone.blp', "Maximum Health", "%%"},
        bmn = { 3,      p_stat_bmana,           "Energy",               'ReplaceableTextures\\CommandButtons\\BTNManaStone.blp', "Maximum Mana", "%%"},

        hlg = { 3,      p_stat_healing,         "Mending",              'ReplaceableTextures\\CommandButtons\\BTNHealingWard.blp', "Healing Power", "%%"},
        abs = { 3,      p_stat_absorb,          "Shielding",            'ReplaceableTextures\\CommandButtons\\BTNPurge.blp', "Absorb Power", "%%"},

        wax = { 3,      p_stat_wax,             "Candle",               'ReplaceableTextures\\CommandButtons\\BTNPotionOfRestoration.blp', "Wax Capacity", "%%"},
        min = { 4,      p_stat_minepwr,         "Mining",               'ReplaceableTextures\\CommandButtons\\BTNGatherGold.blp', "Mining Power", "%%"},
        thr = { 3,      p_stat_thorns,          "Vengeance",            'ReplaceableTextures\\CommandButtons\\BTNMetamorphosis.blp', "Thorns", ""},
        shl = { 2,      p_stat_shielding,       "Shielding",            'ReplaceableTextures\\CommandButtons\\BTNAbsorbMagic.blp', "Absorb on Spell", ""},

        els = { 1,      p_stat_elels,           "Spell Leech",          'ReplaceableTextures\\CommandButtons\\BTNDevourMagic.blp', "Elemental Lifesteal", "%%"},
        pls = { 1,      p_stat_physls,          "Blood Leech",          'ReplaceableTextures\\CommandButtons\\BTNVampiricAura.blp', "Physical Lifesteal", "%%"},

        drd = { 1,      p_stat_dmg_reduct,      "Protection",           'ReplaceableTextures\\CommandButtons\\BTNDefend.blp', "Damage Reduction", "%%"},

        poh = { 2,      p_stat_potionpwr,       "Potion",               'ReplaceableTextures\\CommandButtons\\BTNPotionGreenSmall.blp', "Health Potion Power", "%%"},
        pom = { 2,      p_stat_artifactpwr,     "Artifact",             'ReplaceableTextures\\CommandButtons\\BTNPotionBlueSmall.blp', "Mana Potion Power", "%%"},

        ele = { 1,      p_stat_eleproc,         "Elemental",            'ReplaceableTextures\\CommandButtons\\BTNScatterRockets.blp', "Proliferation", "%%"},
        sum = { 3,      p_stat_miniondmg,       "Summoner",             'ReplaceableTextures\\CommandButtons\\BTNDarkSummoning.blp', "Minion Damage", "%%"},

        arm = { 3,      p_stat_armor,           "Endurance",            'ReplaceableTextures\\CommandButtons\\BTNThoriumArmor.blp', "Armor Rating", ""},
        dog = { 3,      p_stat_dodge,           "Avoidance",            'ReplaceableTextures\\CommandButtons\\BTNCloudOfFog.blp', "Dodge Rating", ""},
    }
    -- template for stat modifier/ability placement:
    mastery.statmap = {}
    mastery.statmap[#mastery.statmap+1] = {"___","ph1","___","___","___","sh1","___","___","___","na1","___","___","___","ab1","___","___","___","hl1","___","___","___","ar1","___","___","___","fi1","___","___","___","fr1","___"}
    mastery.statmap[#mastery.statmap+1] = {"phr","phd","phr","___","shr","shd","shr","___","nar","nad","nar","___","abs","abs","abs","___","hlg","hlg","hlg","___","arr","ard","arr","___","fir","fid","fir","___","frr","frd","frr"}
    mastery.statmap[#mastery.statmap+1] = {"phd","***","phd","___","shd","***","shd","___","nad","***","nad","___","abs","***","abs","___","hlg","***","hlg","___","ard","***","ard","___","fid","***","fid","___","frd","***","frd"}
    mastery.statmap[#mastery.statmap+1] = {"phr","phd","phr","___","shr","shd","shr","___","nar","nad","nar","___","abs","abs","abs","___","hlg","hlg","hlg","___","arr","ard","arr","___","fir","fid","fir","___","frr","frd","frr"}
    mastery.statmap[#mastery.statmap+1] = {"vit","drd","vit","___","vit","str","vit","___","vit","ala","vit","___","vit","str","vit","___","vit","wis","vit","___","vit","ala","vit","___","vit","wis","vit","___","vit","drd","vit"}
    mastery.statmap[#mastery.statmap+1] = {"thr","pls","thr","str","pom","bmn","pom","ala","wax","wax","wax","str","bhp","bhp","bhp","___","bmn","bmn","bmn","wis","min","min","min","ala","poh","bhp","poh","wis","shl","els","shl"}
    mastery.statmap[#mastery.statmap+1] = {"pls","***","pls","str","bmn","***","bmn","ala","wax","***","wax","str","bhp","***","bhp","cen","bmn","***","bmn","wis","min","***","min","ala","bhp","***","bhp","wis","els","***","els"}
    mastery.statmap[#mastery.statmap+1] = {"thr","pls","thr","str","pom","bmn","pom","ala","wax","wax","wax","str","bhp","bhp","bhp","___","bmn","bmn","bmn","wis","min","min","min","ala","poh","bhp","poh","wis","shl","els","shl"}
    mastery.statmap[#mastery.statmap+1] = {"vit","drd","vit","___","vit","str","vit","___","vit","ala","vit","___","vit","str","vit","___","vit","wis","vit","___","vit","ala","vit","___","vit","wis","vit","___","vit","drd","vit"}
    mastery.statmap[#mastery.statmap+1] = {"nar","nad","nar","___","shr","shd","shr","___","phr","phd","phr","___","hlg","hlg","hlg","___","abs","abs","abs","___","frr","frd","frr","___","fir","fid","fir","___","arr","ard","arr"}
    mastery.statmap[#mastery.statmap+1] = {"nad","***","nad","___","shd","***","shd","___","phd","***","phd","___","hlg","***","hlg","___","abs","***","abs","___","frd","***","frd","___","fid","***","fid","___","ard","***","ard"}
    mastery.statmap[#mastery.statmap+1] = {"nar","nad","nar","___","shr","shd","shr","___","phr","phd","phr","___","hlg","hlg","hlg","___","abs","abs","abs","___","frr","frd","frr","___","fir","fid","fir","___","arr","ard","arr"}
    mastery.statmap[#mastery.statmap+1] = {"___","na2","___","___","___","sh2","___","___","___","ph2","___","___","___","hl2","___","___","___","ab2","___","___","___","fr2","___","___","___","fi2","___","___","___","ar2","___"}

    -- mastery.statmap[#mastery.statmap+1] = {"phd","phd","phd","phr","phd","phd","phd","phd","arm","arm","arm","...","hl2","hlg","hlg","...","abs","abs","ab1","...","shl","shl","shl","frd","frd","frd","frd","frr","frd","frd","frd"}
    -- mastery.statmap[#mastery.statmap+1] = {"ph2","phd","phd","phr","phd","phd","phd","ph1","arm","arm","arm","min","hlg","hlg","hlg","...","abs","abs","abs","min","shl","shl","shl","fr1","frd","frd","frd","frr","frd","frd","fr2"}
    -- mastery.statmap[#mastery.statmap+1] = {"phd","phd","phd","phr","phd","phd","phd","phd","arm","arm","arm","min","hlg","hlg","hlg","...","abs","abs","abs","min","shl","shl","shl","frd","frd","frd","frd","frr","frd","frd","frd"}
    -- mastery.statmap[#mastery.statmap+1] = {"___","___","___","___","___","___","___","___","pls","pls","pls","min","bhp","bhp","bhp","...","pom","pom","pom","min","wax","wax","wax","___","___","___","___","___","___","___","___"}
    -- mastery.statmap[#mastery.statmap+1] = {"___","___","___","___","___","___","___","___","pls","pls","pls","...","bhp","bhp","bhp","vit","pom","pom","pom","...","wax","wax","wax","___","___","___","___","___","___","___","___"}
    -- mastery.statmap[#mastery.statmap+1] = {"shd","shd","shd","shr","shd","shd","shd","shd","dog","dog","dog","...","...","...","...","vit","...","...","...","...","ele","ele","ele","nad","nad","nad","nad","nar","nad","nad","nad"}
    -- mastery.statmap[#mastery.statmap+1] = {"sh2","shd","shd","shr","shd","shd","shd","sh1","dog","dog","dog","ala","ala","str","str","cen","wis","wis","vit","vit","ele","ele","ele","na1","nad","nad","nad","nar","nad","nad","na2"}
    -- mastery.statmap[#mastery.statmap+1] = {"shd","shd","shd","shr","shd","shd","shd","shd","dog","dog","dog","...","...","...","...","vit","...","...","...","...","ele","ele","ele","nad","nad","nad","nad","nar","nad","nad","nad"}
    -- mastery.statmap[#mastery.statmap+1] = {"___","___","___","___","___","___","___","___","wax","wax","wax","...","poh","poh","poh","vit","bhp","bhp","bhp","...","els","els","els","___","___","___","___","___","___","___","___"}
    -- mastery.statmap[#mastery.statmap+1] = {"___","___","___","___","___","___","___","___","wax","wax","wax","min","poh","poh","poh","...","bhp","bhp","bhp","min","els","els","els","___","___","___","___","___","___","___","___"}
    -- mastery.statmap[#mastery.statmap+1] = {"fid","fid","fid","fir","fid","fid","fid","fid","sum","sum","sum","min","abs","abs","abs","...","hlg","hlg","hlg","min","bmn","bmn","bmn","ard","ard","ard","ard","arr","ard","ard","ard"}
    -- mastery.statmap[#mastery.statmap+1] = {"fi2","fid","fid","fir","fid","fid","fid","fi1","sum","sum","sum","min","abs","abs","abs","...","hlg","hlg","hlg","min","bmn","bmn","bmn","ar1","ard","ard","ard","arr","ard","ard","ar2"}
    -- mastery.statmap[#mastery.statmap+1] = {"fid","fid","fid","fir","fid","fid","fid","fid","sum","sum","sum","...","ab2","abs","abs","...","hlg","hlg","hl1","...","bmn","bmn","bmn","ard","ard","ard","ard","arr","ard","ard","ard"}
    -- build advtip tables:
    mastery.statadvtip = {}
    mastery.abiladvtip = {}
    for statcode,t in pairs(mastery.statlist) do
        mastery.statlist[statcode].advtip = {}
        mastery.statlist[statcode].advtipanchor     = fp.bl
        mastery.statlist[statcode].advattachanchor  = fp.tr
        mastery.statlist[statcode].advtip[1] = t[4]
        mastery.statlist[statcode].advtip[2] = color:wrap(color.tooltip.alert, t[3].." Mastery")
        mastery.statlist[statcode].advtip[3] = "Gain "..color:wrap(color.tooltip.good, t[1]..t[6]).." "..color:wrap(color.tooltip.good, t[5])
            .."."..mastery.tipinfo
    end
    for abilcode,t in pairs(mastery.abillist) do
        mastery.abillist[abilcode].advtip = {}
        mastery.abillist[abilcode].advtipanchor     = fp.bl
        mastery.abillist[abilcode].advattachanchor  = fp.tr
        mastery.abillist[abilcode].advtip[1] = mastery.abillist[abilcode].icon
        mastery.abillist[abilcode].advtip[2] = 
            color:wrap(color.tooltip.alert, mastery.abillist[abilcode].name)
            ..color:wrap(color.txt.txtdisable, "|nMana Cost: "..tostring(mastery.abillist[abilcode].cost or 0))
            ..color:wrap(color.txt.txtdisable, "|nCooldown: "..tostring(mastery.abillist[abilcode].cd or 0).." sec")
        mastery.abillist[abilcode].advtip[3] = mastery.abillist[abilcode].descript..mastery.tipinfo2
    end
end


function mastery:new()
    local o = {}
    -- create new selected data table:
    for row = 1,self.nodemaxy do
        o[row] = {}
        for col = 1,self.nodemaxx do
            o[row][col] = false
        end
    end
    setmetatable(o, self)
    return o
end


function mastery:createplayertables()
    for pnum = 1,kk.maxplayers do
        local p = Player(pnum-1)
        if kobold.player[p] then
            kobold.player[p].mastery   = mastery:new()
            kobold.player[p].mastery.p = p
        end
    end
end


function mastery:buildpanel()
    local fr    = kui:createmassivepanel("MASTERY", kui.meta.masterypanel.tex)
    local nodex = kui:px(kui.meta.masterypanel.nodex) -- starting x
    local nodey = kui:px(kui.meta.masterypanel.nodey) -- `` y
    local x,y   = nodex,nodey
    local w,h   = kui:px(40),kui:px(40)
    local iw    = kui:px(22) -- abil/passive icon width/height.
    local off   = w*1.0
    fr.clickfunc = {}
    fr.node = {}
    for row = 1,mastery.nodemaxy do
        fr.node[row] = {}
        fr.clickfunc[row] = {}
        for col = 1,mastery.nodemaxx do
            if col == mastery.centerx and row == mastery.centery then -- center starting point marker
                fr.node.center = kui.frame:newbytype("BACKDROP", fr)
                fr.node.center:addbgtex(kui.meta.masterypanel.texstart)
                fr.node.center:setsize(kui:px(48), kui:px(48))
                fr.node.center:setfp(fp.c, fp.c, fr, x, y)
            end
            if mastery.nodemap[row][col] ~= 0 then
                local nodeid = mastery.nodemap[row][col]
                local isabil = false
                if nodeid == -1 then nodeid = 1 end -- hacky reverse since center is marked negative.
                -- create nodes:
                fr.node[row][col] = kui.frame:newbtntemplate(fr, kui.meta.masterypanel[nodeid].tex) -- node bg and event wrapper (runes also set here).
                fr.node[row][col].btn.advtip = mastery:getadvtip(row, col, fr, nodeid == 2)
                fr.node[row][col].btn:addevents(function() mastery:updateadvtipanchor(row, col, fr, nodeid == 2) end, nil, nil)
                fr.node[row][col].btn:initializeadvtip()
                fr.node[row][col]:setnewalpha(75)
                if nodeid == 1 or nodeid == 2 then
                    fr.node[row][col].icon = kui.frame:newbytype("BACKDROP", fr.node[row][col])
                    fr.node[row][col].icon:setsize(iw, iw)
                    fr.node[row][col].icon:setfp(fp.c, fp.c, fr.node[row][col])
                    fr.node[row][col].icon:setnewalpha(125)
                    fr.node[row][col].icon:addbgtex(mastery:getnodeicon(row, col, fr, nodeid == 2))
                    fr.clickfunc[row][col] = function()
                        local p     = utils.trigp()
                        local pobj  = kobold.player[p]
                        if (not pobj.mastery:nodeistaken(row,col) and pobj.mastery:verifypath(row,col)) then
                            if pobj.mastery.points > 0 then
                                fr.respec:show()
                                pobj.mastery[row][col] = true
                                pobj.mastery:spendpoint()
                                pobj.mastery:verifysurround(pobj.mastery:findruneword(row,col))
                                mastery:addstat(pobj, row, col, nodeid == 2)
                                if p == utils.localp() then
                                    fr.node[row][col]:setbgtex(kui.meta.masterypanel[nodeid].texsel)
                                    fr.node[row][col]:setnewalpha(255)
                                    fr.node[row][col].icon:setnewalpha(255)
                                    utils.playsound(kui.sound.selnode)
                                end
                                -- if center unlock node:
                                if mastery.statmap[row][col] == "cen" then
                                    -- 5% bonus health from center node:
                                    pobj:modstat(p_stat_bhp, true, 5)
                                    fr.respec:hide() -- don't allow respecs if only center is unlocked.
                                    -- remove hover tooltip:
                                    -- NOTE: disabled these because it doesnt support multiplayer (tip tables are singletons atm).
                                    -- tooltip:get('masterycenter').txt = "(Mastery Tree Unlocked) "..color:wrap(color.tooltip.good,"+5%% Maximum Health")
                                    --DestroyTrigger(fr.node[row][col].btn.mouseenter.trig) fr.node[row][col].btn.mouseenter = nil
                                end
                            else
                                utils.palert(p, "You don't have any available mastery points!")
                            end
                        end
                        -- if ability node and learned, run learn func:
                        if pobj.mastery[row][col] and mastery.abillist[mastery.statmap[row][col]] then
                            pobj.ability:learnmastery(mastery.statmap[row][col]) -- pass in the abilid (e.g. 'na1').
                        end
                        pobj = nil
                    end
                    fr.node[row][col].btn:addevents(nil, nil, fr.clickfunc[row][col])
                    fr.node[row][col].btn:addhoverscale(fr.node[row][col], 1.12)
                elseif nodeid > 2 then
                    fr.node[row][col]:setnewalpha(125)
                end
                if nodeid == 2 then
                    fr.node[row][col]:setsize(w*1.25, h*1.25)
                    fr.node[row][col].icon:setsize(iw*1.25, iw*1.25)
                else
                    fr.node[row][col]:setsize(w, h)
                end
                fr.node[row][col]:setabsfp(fp.c, x + kui.position.centerx, y + 0.32 + kui:px(kui.meta.skillh*0.5) )
                fr.node[row][col].col = col
                fr.node[row][col].row = row
            end
            x = x + off
        end
        x = nodex
        y = y - off
    end
    -- unlearn all button:
    fr.unlearn = kui.frame:newbtntemplate(fr, 'war3mapImported\\btn-mastery-unlearn-all-spells.blp')
    fr.unlearn:setsize(kui:px(22), kui:px(30))
    fr.unlearn:setfp(fp.bl, fp.b, kui.worldui, kui:px(365), kui:px(117))
    fr.unlearn.btn:assigntooltip("unlearnmastery")
    fr.unlearn.btn:addevents(nil, nil, function()
        if not map.manager.activemap then
            kobold.player[utils.trigp()].mastery:unlearnabilities(kobold.player[utils.trigp()])
        else
            utils.palert(p, "Cannot reset abilities during a dig!")
        end
    end)
    fr.unlearn:show()
    -- respec masteries button:
    fr.respec = kui.frame:newbtntemplate(fr, 'war3mapImported\\btn-mastery_reset.blp')
    fr.respec:setsize(kui:px(35), kui:px(35))
    fr.respec:setfp(fp.c, fp.c, fr, kui:px(136), kui:px(-296))
    fr.respec.btn:assigntooltip("respecmastery")
    fr.respec.btn:addevents(nil, nil, function()
        local p = utils.trigp()
        if not map.manager.activemap then
            if kobold.player[p].gold >= 5000 then
                kui:showmodal(function()
                    if kobold.player[p].gold >= 5000 then
                        utils.playsound(kui.sound.runenode)
                        kobold.player[p]:awardgold(-5000)
                        kobold.player[p].mastery:resetall(kobold.player[p])
                    else
                        utils.palert(p, "You don't have enough gold!")
                    end
                end)
            else
                utils.palert(p, "Not enough gold!")
            end
        else
            utils.palert(p, "Cannot reset points during a dig!")
        end
    end)
    fr.respec:hide() -- only shows when points have been spent
    -- points display:
    fr.pointsbd = kui.frame:newbytype("BACKDROP", fr)
    fr.pointsbd:addbgtex("war3mapImported\\ui-scroll_decoration.blp")
    fr.pointsbd:setsize(kui:px(240), kui:px(60))
    fr.pointsbd:setfp(fp.c, fp.b, fr, 0.0, kui:px(30))
    fr.points = fr.pointsbd:createtext("Points Available: "..color:wrap(color.txt.txtdisable,"0"), nil, true) -- left block
    fr.points:setsize(kui:px(160), kui:px(26))
    fr.points:setfp(fp.c, fp.c, fr.pointsbd, 0.0, kui:px(3))
    fr.points:assigntooltip("attrzero")
    fr.panelid  = 5
    fr.statesnd = true
    fr:hide()
    -- generate player mastery templates:
    mastery:createplayertables()
    return fr
end


function mastery:getnodeicon(row, col, fr, _isabil)
    if _isabil then
        return mastery.abillist[mastery.statmap[row][col]].icon
    else
        if mastery:validnodeid(row, col) then
            return mastery.statlist[mastery.statmap[row][col]][4]
        elseif mastery.statmap[row][col] == "cen" then
            fr.node[row][col].btn:assigntooltip("masterycenter")
        end
    end
    return kui.tex.invis
end


-- assign a prebuilt advtip table to a mastery node.
function mastery:getadvtip(row, col, fr, _isabil)
    if mastery:validnodeid(row, col) then
        if _isabil then
            return mastery.abillist[mastery.statmap[row][col]].advtip
        elseif mastery.statlist[mastery.statmap[row][col]] then
            return mastery.statlist[mastery.statmap[row][col]].advtip
        end
    end
end


function mastery:validnodeid(row, col)
    return mastery.statmap[row][col] ~= "___" and mastery.statmap[row][col] ~= "cen" and mastery.statmap[row][col] ~= "***"
end


-- when on the right side of the panel, change the tip anchor point to prevent frame squish.
function mastery:updateadvtipanchor(row, col, fr)
    if col > 15 then
        fr.node[row][col].btn.advattachanchor = fp.bl
        if row > 6 then
            fr.node[row][col].btn.advtipanchor = fp.r
        else
            fr.node[row][col].btn.advtipanchor = fp.tr
        end
    else
        fr.node[row][col].btn.advattachanchor = fp.br
        if row > 6 then
            fr.node[row][col].btn.advtipanchor = fp.l
        else
            fr.node[row][col].btn.advtipanchor = fp.tl
        end
    end
end


-- add assigned player stat when a node is learned.
function mastery:addstat(pobj, row, col, _isabil, _removebool)
    if not _isabil and mastery.statmap[row][col] ~= "cen" and mastery.statmap[row][col] ~= "***" then
        if _removebool then
            pobj:modstat(mastery.statlist[mastery.statmap[row][col]][2], false, mastery.statlist[mastery.statmap[row][col]][1])
        else
            pobj:modstat(mastery.statlist[mastery.statmap[row][col]][2], true, mastery.statlist[mastery.statmap[row][col]][1])
        end
    end
end


-- @row,col = selected node.
function mastery:verifypath(row,col)
    -- mastery template set to true = node is learned.
    if mastery.nodemap[row][col] < 3 then -- ignore runeword markers.
        if mastery.nodemap[row][col] == -1 then -- center start loc.
            return true
        -- search nearby learned nodes:
        elseif self[row][col+1] and self[row][col+1] == true then -- right
            return true
        elseif self[row+1] and self[row+1][col] and self[row+1][col] == true then -- down
            return true
        elseif self[row][col-1] and self[row][col-1] == true then -- left
            return true
        elseif self[row-1] and self[row-1][col] and self[row-1][col] == true then -- up
            return true
        end
    else
        return false
    end
    return false
end


-- @row,col = selected node loc.
-- returns row,col if runeword found.
function mastery:findruneword(row,col)
    -- look around a selected node to see if a
    --  runeword check should be done.
    local y, x = row-1, col-1
    for l = 1,8 do
        y,x = mastery:loopcheck(l, y, x)
        if mastery.nodemap[y] and mastery.nodemap[y][x] and mastery.nodemap[y][x] > 2 then
            return y,x -- return row, col
        end
    end
    return false
end


-- @row,col = runeword loc.
function mastery:verifysurround(row,col)
    if row and col then
        -- verify a runeword is surrounded if near it.
        local y, x, c = row-1, col-1, 0
        for l = 1,8 do
            y,x = mastery:loopcheck(l, y, x)
            if self[y] and self[y][x] == true then
                c = c + 1
                if c == 8 then
                    -- self[row][col] = true
                    if self.p == utils.localp() then
                        kui.canvas.game.mast.node[row][col]:setbgtex(kui.meta.masterypanel[mastery.nodemap[row][col]].texact)
                        kui.canvas.game.mast.node[row][col]:setnewalpha(255)
                        utils.playsound(kui.sound.runenode)
                    end
                end
            else
                break
            end
        end
    end
end


function mastery:loopcheck(l,y,x)
    local newy,newx = y,x
    -- do an 8-unit square loop starting at top left corner.
    if l ~= 1 then
        if     l  < 4 then newx = newx + 1     -- shift right
        elseif l  < 6 then newy = newy + 1     -- shift down
        elseif l  < 8 then newx = newx - 1     -- shift left
        elseif l == 8 then newy = newy - 1 end -- shift up
    end
    return newy,newx
end


function mastery:nodeistaken(row,col)
    if self[row][col] == true then
        return true
    end
    return false
end


function mastery:addpoint(val)
    local val = val or 1
    self.points = self.points + val
    self:refreshtooltip()
end


function mastery:spendpoint(val)
    local val = val or 1
    self.points = self.points - val
    self:refreshtooltip()
end


function mastery:refreshtooltip()
    if self.p == utils.localp() then
        local col = color.txt.txtdisable
        if self.points < 1 then col = color.txt.txtdisable else col = color.tooltip.good end
        kui.canvas.game.mast.points:settext("Points Available: "..color:wrap(col, self.points))
    end
end


function mastery:unlearnabilities(pobj)
    local p = utils.trigp()
    for abilid,_ in pairs(mastery.abillist) do
        for col = 5,8 do
            -- TODO: this is a copy and paste from ability.template:learnmastery, need to unify
            if pobj.ability.spells[col] and pobj.ability.spells[col][abilid] then -- already learned, flag to remove from bar.
                for casttype,rawcode in pairs(hotkey.map.codet[hotkey.map.intmap[col]]) do
                    if BlzGetUnitAbility(kobold.player[pobj.ability.p].unit, rawcode)
                            and BlzGetUnitAbilityCooldownRemaining(kobold.player[pobj.ability.p].unit, rawcode) > 0 then
                        utils.palert(pobj.ability.p, "You cannot remove a mastery ability while it's on cooldown!")
                        return
                    end
                end
                -- update key before clearing:
                kobold.player[pobj.ability.p].keymap:clearkey(hotkey.map.intmap[col], pobj.ability.spells[col][abilid].casttype)
                pobj.ability.spells[col][abilid] = nil
                pobj.ability.spells[col]         = nil
                pobj.ability[col][1]             = nil
                kui.canvas.game.skill.skill[col].cdtxt.advtip = nil
                if pobj.ability.p == utils.localp() then
                    kui.canvas.game.skill.skill[col].fill:setbgtex(kui.color.black)
                    utils.playsound(kui.sound.closebtn, pobj.ability.p)
                end
            end
        end
    end
end


function mastery:resetall(pobj)
    local nodeid, totalpoints = 1, 0
    pobj.mastery:unlearnabilities(pobj) -- unlearn all abils.
    pobj.ability.savedmastery = nil -- reset save/load config.
    for row = 1,mastery.nodemaxy do
        for col = 1,mastery.nodemaxx do
            nodeid = mastery.nodemap[row][col]
            if nodeid == -1 then nodeid = 1 end -- hacky reverse since center is marked negative.
            -- undo learned node settings:
            if pobj.mastery[row][col] == true and not (col == mastery.centerx and row == mastery.centery) then
                -- non-center nodes.
                totalpoints = totalpoints + 1
                -- force reset every row/col value:
                pobj.mastery:addstat(pobj, row, col, nodeid == 2, true)
                pobj.mastery[row][col] = false
                -- reset icons:
                kui.canvas.game.mast.node[row][col].icon:setbgtex(mastery:getnodeicon(row, col, kui.canvas.game.mast, nodeid == 2))
                kui.canvas.game.mast.node[row][col].icon:setnewalpha(125)
                -- background activation icons:
                kui.canvas.game.mast.node[row][col]:setbgtex(kui.meta.masterypanel[nodeid].tex)
                kui.canvas.game.mast.node[row][col]:setnewalpha(75)
            end
            -- if a rune, reset alpha:
            if nodeid > 2 and not (col == mastery.centerx and row == mastery.centery) then
                kui.canvas.game.mast.node[row][col]:setbgtex(kui.meta.masterypanel[nodeid].tex)
                kui.canvas.game.mast.node[row][col]:setnewalpha(125)
            end
        end
    end
    -- add back all removed points:
    pobj.mastery:addpoint(totalpoints)
    if utils.islocalp(pobj.p) then
        kui.canvas.game.mast.respec:hide()
    end
end
